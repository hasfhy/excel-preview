<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel åœ¨çº¿é¢„è§ˆ</title>
    
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background-color: #f5f5f5;
            margin: 20px;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        h2 { margin: 0; font-size: 20px; color: #333; }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        #update-time {
            font-size: 14px;
            color: #666;
        }

        /* åˆ·æ–°æŒ‰é’®æ ·å¼ */
        .btn-refresh {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-refresh:hover {
            background-color: #0056b3;
        }
        .btn-refresh:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* è¡¨å¤´æ ·å¼ */
        thead th {
            background-color: #f1f3f4;
            font-weight: bold;
            border-bottom: 2px solid #ddd !important;
            white-space: nowrap;
        }
        
        /* ç­›é€‰ä¸‹æ‹‰æ¡†æ ·å¼ */
        .filter-select {
            width: 100%;
            padding: 4px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
            font-size: 12px;
        }

        /* é®ç½©å±‚ */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-mask">
    <div class="spinner"></div>
    <div id="status-text">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
</div>

<div class="container">
    <div class="header-bar">
        <h2>ğŸ“Š æ•°æ®é¢„è§ˆ</h2>
        <div class="controls">
            <span id="update-time">ä¸Šæ¬¡æ›´æ–°: --</span>
            <button id="refresh-btn" class="btn-refresh">
                ğŸ”„ ç«‹å³åˆ·æ–°
            </button>
        </div>
    </div>

    <table id="excel-table" class="display nowrap" style="width:100%">
        </table>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

<script>
    // é…ç½®é¡¹
    const CONFIG = {
        url: 'data.xlsx',       // Excel æ–‡ä»¶è·¯å¾„
        pageSize: 100           // æ¯é¡µæ˜¾ç¤ºæ¡æ•°
    };

    let dataTable = null;

    $(document).ready(function() {
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–ä¸€æ¬¡
        loadData();

        // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#refresh-btn').on('click', function() {
            loadData();
        });
    });

    // æ ¸å¿ƒé€»è¾‘ï¼šåŠ è½½å¹¶è§£ææ•°æ®
    async function loadData() {
        const $btn = $('#refresh-btn');
        
        try {
            // UI çŠ¶æ€æ›´æ–°ï¼šæ˜¾ç¤ºé®ç½©ï¼Œç¦ç”¨æŒ‰é’®
            $('#loading-mask').show();
            $('#status-text').text('æ­£åœ¨ä¸‹è½½æ•°æ®...');
            $btn.prop('disabled', true).html('â³ åŠ è½½ä¸­...');

            // 1. ä¸‹è½½æ–‡ä»¶ (åŠ æ—¶é—´æˆ³é˜²ç¼“å­˜)
            const timestamp = new Date().getTime();
            const response = await fetch(`${CONFIG.url}?t=${timestamp}`);
            if (!response.ok) throw new Error(`HTTP é”™è¯¯: ${response.status}`);
            
            const ab = await response.arrayBuffer();
            
            $('#status-text').text('æ­£åœ¨è§£æ Excel...');
            
            // 2. è§£æ Excel
            const workbook = XLSX.read(ab, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            
            // ä½¿ç”¨ header:1 è·å–åŸå§‹äºŒç»´æ•°ç»„
            const rawData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            if (!rawData || rawData.length === 0) throw new Error("Excel æ–‡ä»¶ä¸ºç©º");

            // 3. æ•°æ®æ¸…æ´—ä¸æ ‡å‡†åŒ–
            const normalized = normalizeData(rawData);
            
            // 4. æ¸²æŸ“è¡¨æ ¼
            renderTable(normalized.headers, normalized.body);

            // æ›´æ–°æˆåŠŸçŠ¶æ€
            const now = new Date();
            $('#update-time').text('ä¸Šæ¬¡æ›´æ–°: ' + now.toLocaleTimeString());
            $('#loading-mask').fadeOut(300);

        } catch (e) {
            console.error(e);
            $('#status-text').html(`<span style="color:red">é”™è¯¯: ${e.message}</span>`);
            alert(`åŠ è½½å¤±è´¥: ${e.message}`);
            // å‡ºé”™ä¹Ÿéœ€è¦ç§»é™¤é®ç½©ï¼Œå¦åˆ™ç”¨æˆ·å¡æ­»
            $('#loading-mask').fadeOut(300);
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            $btn.prop('disabled', false).html('ğŸ”„ ç«‹å³åˆ·æ–°');
        }
    }

    // æ•°æ®æ ‡å‡†åŒ–ï¼šç¡®ä¿çŸ©é˜µæ˜¯å®Œæ•´çš„çŸ©å½¢ (ä¿æŒä¸å˜ï¼Œç”¨äºé˜²æ­¢æŠ¥é”™)
    function normalizeData(rawData) {
        // è®¡ç®—æœ€å¤§åˆ—æ•°
        let maxCols = 0;
        rawData.forEach(row => {
            if (row.length > maxCols) maxCols = row.length;
        });

        // åˆ†ç¦»è¡¨å¤´å’Œæ•°æ®
        let headers = rawData[0] || [];
        let body = rawData.slice(1);

        // è¡¥å…¨è¡¨å¤´
        while (headers.length < maxCols) {
            headers.push(`æœªå‘½ååˆ— ${headers.length + 1}`);
        }

        // è¡¥å…¨æ•°æ®è¡Œ
        const cleanBody = body.map(row => {
            const newRow = [];
            for (let i = 0; i < maxCols; i++) {
                const cell = row[i];
                newRow.push((cell === undefined || cell === null) ? "" : String(cell));
            }
            return newRow;
        });

        return { headers, body: cleanBody };
    }

    function renderTable(headers, bodyData) {
        const $table = $('#excel-table');

        if (dataTable) {
            dataTable.destroy();
            $table.empty(); 
        }

        const columnsConfig = headers.map((title, index) => {
            return { 
                title: title || `åˆ— ${index}`,
                defaultContent: "" 
            };
        });

        dataTable = $table.DataTable({
            data: bodyData,
            columns: columnsConfig,
            destroy: true,
            pageLength: CONFIG.pageSize,
            lengthMenu: [[25, 50, 100, 500, -1], [25, 50, 100, 500, "å…¨éƒ¨"]],
            orderCellsTop: true,
            fixedHeader: true,
            scrollX: true,
            language: {
                "processing": "å¤„ç†ä¸­...",
                "lengthMenu": "æ˜¾ç¤º _MENU_ é¡¹",
                "zeroRecords": "æ²¡æœ‰åŒ¹é…ç»“æœ",
                "info": "æ˜¾ç¤ºç¬¬ _START_ è‡³ _END_ é¡¹ç»“æœï¼Œå…± _TOTAL_ é¡¹",
                "infoEmpty": "æ— æ•°æ®",
                "infoFiltered": "(ç”± _MAX_ é¡¹ç»“æœè¿‡æ»¤)",
                "search": "å…¨å±€æœç´¢:",
                "paginate": { "next": "ä¸‹é¡µ", "previous": "ä¸Šé¡µ" }
            },
            initComplete: function () {
                const api = this.api();
                const $thead = $(api.table().header());
                
                if ($thead.find('tr.filter-row').length > 0) return;

                const trClone = $thead.find('tr:eq(0)').clone(true).addClass('filter-row').appendTo($thead);
                
                trClone.find('th').each(function(i) {
                    const $th = $(this);
                    $th.html(''); 
                    $th.removeClass('sorting sorting_asc sorting_desc');

                    const select = $('<select class="filter-select"><option value="">å…¨éƒ¨</option></select>')
                        .appendTo($th)
                        .on('click', function(e) { e.stopPropagation(); })
                        .on('change', function() {
                            const val = $.fn.dataTable.util.escapeRegex($(this).val());
                            api.column(i).search(val ? '^' + val + '$' : '', true, false).draw();
                        });

                    api.column(i).data().unique().sort().each(function(d) {
                        if (d !== "") {
                            let text = d;
                            if (text.length > 20) text = text.substr(0,20) + '...';
                            select.append('<option value="' + d + '">' + text + '</option>');
                        }
                    });
                });
            }
        });
    }
</script>
</body>
</html>
