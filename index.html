<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨åœºç®±åˆ—è¡¨</title>
    
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background-color: #f5f5f5;
            margin: 20px;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        h2 { margin: 0; font-size: 20px; color: #333; }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        /* ç™½è‰²è¶…é“¾æ¥ï¼Œæ— ä¸‹åˆ’çº¿ï¼Œæ‚¬åœä»ä¸ºç™½è‰² */
        a.white-link,
        a.white-link:link,
        a.white-link:visited {
            color: #ffffff;               /* å­—ä½“ç™½è‰² */
            text-decoration: none;        /* å–æ¶ˆä¸‹åˆ’çº¿ */
        }

/* æ‚¬åœ/æŒ‰ä¸‹/èšç„¦ä¹Ÿä¿æŒç™½è‰²å¹¶æ— ä¸‹åˆ’çº¿ */
        a.white-link:hover,
        a.white-link:active,
        a.white-link:focus {
            color: #ffffff;
            text-decoration: none;
        }
        #m-time {
            font-size: 14px;
            color: #666;
        }
        .btn-bar {
            text-align: left;
        }
        /* åˆ·æ–°æŒ‰é’®æ ·å¼ */
        .btn-refresh {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-refresh:hover {
            background-color: #0056b3;
        }
        .btn-refresh:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .btn-download {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-download:hover {
            background-color: #0056b3;
        }
        .btn-download:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* è¡¨å¤´æ ·å¼ */
        thead th {
            background-color: #f1f3f4;
            font-weight: bold;
            border-bottom: 2px solid #ddd !important;
            white-space: nowrap;
        }
        
        /* ç­›é€‰ä¸‹æ‹‰æ¡†æ ·å¼ */
        .filter-select {
            width: 100%;
            padding: 4px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
            font-size: 12px;
        }

        /* é®ç½©å±‚ */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-mask">
    <div class="spinner"></div>
    <div id="status-text">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
</div>

<div class="container">
    <div class="header-bar">
        <h2>ğŸ“Šåœ¨åœºç®±åˆ—è¡¨</h2>
        <div class="btn-bar"><button id="refresh-btn" class="btn-refresh">ğŸ”„ åˆ·æ–°é¡µé¢</button></div>
        <div class="controls">            
        <span id="m-time">åœ¨åœºç®±åˆ—è¡¨æ›´æ–°æ—¶é—´ï¼š<div id="mtime"></div></span>
        <button id="download-btn" class="btn-download"><a href="http://49.82.160.226:9088/api/v1/business/web_enquiry/container/on_yard_container/export?cstAgent=&amp;cstCopercd=&amp;billNo=&amp;containerNo=&amp;iycVesselInfo=&amp;containerSize=&amp;containerType=&amp;IEFG=&amp;iycPotLdport=&amp;iycPotDstport=&amp;EFFG=&amp;iycDangerFg=&amp;termServiceName=phWebEnquiryService"  target="_blank" class="white-link">
       ä¸‹è½½</a></button>

        </div>
    </div>

    <table id="excel-table" class="display nowrap" style="width:100%">
        </table>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

<script>
    // === è¡¨æ ¼æ›´æ–°æ—¶é—´ ===
async function getFileMTime(url) {
  const res = await fetch(url, { method: "HEAD" });
  const lastModified = res.headers.get("Last-Modified");

  if (lastModified) {
    const dt = new Date(lastModified);
    document.getElementById('mtime').innerText =
      dt.toLocaleString();
  } else {
    document.getElementById('mtime').innerText = "æ— æ³•è·å–æ–‡ä»¶æ—¶é—´";
  }
}

// è¿™é‡Œå†™ä½ çš„æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹æ ¹ç›®å½•ï¼‰
getFileMTime("/data.xlsx");
    // ============================================
    // === æ ¸å¿ƒé…ç½®åŒº ===
    // ============================================
    const CONFIG = {
        url: 'data.xlsx',       
        pageSize: 100,          
        // é…ç½®ä½ è¦æ˜¾ç¤ºçš„åˆ—
        visibleColumns: ["æŒç®±äºº", "èˆ¹å…¬å¸ç®±å‹", "æå•å·","ç®±å·", "ç©ºé‡", "åœºç®±ä½","å…¥åœºæ—¶é—´", "èˆ¹åèˆªæ¬¡", "æ”¾è¡Œ", "æ‰£ç®±"] 
    };

    // === æ–°å¢ï¼šæŒ‡å®šéœ€è¦å¼ºåˆ¶è½¬æ¢æ—¶é—´çš„åˆ—å ===
    const DATE_COLUMNS = ["å…¥åœºæ—¶é—´"]; 
    // =====================================

    let dataTable = null;

    $(document).ready(function() {
        loadData();
        $('#refresh-btn').on('click', function() { loadData(); });
    });

    async function loadData() {
        const $btn = $('#refresh-btn');
        try {
            $('#loading-mask').show();
            $('#status-text').text('æ­£åœ¨ä¸‹è½½æ•°æ®...');
            $btn.prop('disabled', true).html('â³ åŠ è½½ä¸­...');

            const timestamp = new Date().getTime();
            const response = await fetch(`${CONFIG.url}?t=${timestamp}`);
            if (!response.ok) throw new Error(`HTTP é”™è¯¯: ${response.status}`);
            
            const ab = await response.arrayBuffer();
            $('#status-text').text('æ­£åœ¨è§£ææ•°æ®...');
            
            // 1. è¯»å– Excel (å–æ¶ˆ cellDatesï¼Œæˆ‘ä»¬æ‰‹åŠ¨å¤„ç†æ›´ç¨³å¦¥)
            const workbook = XLSX.read(ab, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rawData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            if (!rawData || rawData.length === 0) throw new Error("Excel æ–‡ä»¶ä¸ºç©º");

            // 2. æ•°æ®æ¸…æ´—ä¸å¼ºåˆ¶æ—¶é—´æ ¼å¼åŒ–
            const normalized = normalizeData(rawData);
            
            // 3. æ¸²æŸ“è¡¨æ ¼
            renderTable(normalized.headers, normalized.body);

            const now = new Date();
            $('#update-time').text('åˆ·æ–°æ—¶é—´: ' + new Date().toLocaleString());
            $('#loading-mask').fadeOut(300);

        } catch (e) {
            console.error(e);
            $('#status-text').html(`<span style="color:red">é”™è¯¯: ${e.message}</span>`);
            alert(`åŠ è½½å¤±è´¥: ${e.message}`);
            $('#loading-mask').fadeOut(300);
        } finally {
            $btn.prop('disabled', false).html('ğŸ”„ åˆ·æ–°é¡µé¢');
        }
    }

    // === æ ¸å¿ƒä¿®æ”¹ï¼šæ•°æ®æ ‡å‡†åŒ–ä¸æ—¶é—´è½¬æ¢ ===
    function normalizeData(rawData) {
        // 1. è®¡ç®—æœ€å¤§åˆ—æ•°
        let maxCols = 0;
        rawData.forEach(row => { if (row.length > maxCols) maxCols = row.length; });
        
        // 2. è·å–è¡¨å¤´å¹¶è¡¥å…¨
        let headers = rawData[0] || [];
        while (headers.length < maxCols) { headers.push(`æœªå‘½ååˆ— ${headers.length + 1}`); }

        // 3. æ‰¾åˆ°â€œå…¥åœºæ—¶é—´â€åœ¨ç¬¬å‡ åˆ—ï¼ˆç´¢å¼•ï¼‰
        // è¿™æ ·æˆ‘ä»¬å¯ä»¥ç²¾å‡†æ‰“å‡»ï¼Œåªå¤„ç†è¿™ä¸€åˆ—
        const dateColumnIndices = [];
        headers.forEach((colName, index) => {
            if (DATE_COLUMNS.includes(colName)) {
                dateColumnIndices.push(index);
            }
        });

        const body = rawData.slice(1);
        const cleanBody = body.map(row => {
            const newRow = [];
            for (let i = 0; i < maxCols; i++) {
                let cell = row[i];
                
                // --- å¼ºåˆ¶æ—¶é—´è½¬æ¢é€»è¾‘ ---
                // å¦‚æœå½“å‰åˆ—æ˜¯â€œå…¥åœºæ—¶é—´â€ï¼Œä¸”å€¼æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆä¾‹å¦‚ 45981.63...ï¼‰
                if (dateColumnIndices.includes(i) && typeof cell === 'number') {
                    cell = excelSerialDateToJSDate(cell); // è½¬æ¢
                }
                // ---------------------

                newRow.push((cell === undefined || cell === null) ? "" : String(cell));
            }
            return newRow;
        });
        return { headers, body: cleanBody };
    }

    // === å·¥å…·å‡½æ•°ï¼šå°† Excel æ•°å­—æ—¥æœŸ (45981.xx) è½¬æ¢ä¸º å­—ç¬¦ä¸² ===
    function excelSerialDateToJSDate(serial) {
        // Excel çš„åŸºå‡†æ—¥æ˜¯ 1899-12-30
        // ç®—æ³•ï¼š(Excelæ•°å­— - 25569) * 86400 * 1000 = UTCæ¯«ç§’æ•°
        const utc_days  = Math.floor(serial - 25569);
        const utc_value = utc_days * 86400; 
        const date_info = new Date(utc_value * 1000);

        const fractional_day = serial - Math.floor(serial) + 0.0000001;
        const total_seconds = Math.floor(86400 * fractional_day);

        const seconds = total_seconds % 60;
        const minutes = Math.floor(total_seconds / 60) % 60;
        const hours = Math.floor(total_seconds / 3600);

        // æ„å»ºæ—¥æœŸå¯¹è±¡ (ä½¿ç”¨ UTC æ–¹æ³•è·å–ï¼Œé¿å…æ—¶åŒºåç§»)
        const dt = new Date(Date.UTC(date_info.getUTCFullYear(), date_info.getUTCMonth(), date_info.getUTCDate(), hours, minutes, seconds));
        
        return formatDate(dt);
    }

    // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY/MM/DD HH:mm:ss
    function formatDate(date) {
        if (isNaN(date.getTime())) return ""; 
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        const s = String(date.getSeconds()).padStart(2, '0');
        return `${y}/${m}/${d} ${h}:${min}:${s}`;
    }

    function renderTable(headers, bodyData) {
        const $table = $('#excel-table');

        if (dataTable) {
            dataTable.destroy();
            $table.empty(); 
        }

        const columnsConfig = headers.map((title, index) => {
            let isVisible = true;
            if (CONFIG.visibleColumns.length > 0) {
                isVisible = CONFIG.visibleColumns.includes(title);
            }
            return { 
                title: title || `åˆ— ${index}`,
                defaultContent: "", 
                visible: isVisible
            };
        });

        dataTable = $table.DataTable({
            data: bodyData,
            columns: columnsConfig,
            destroy: true,
            pageLength: CONFIG.pageSize,
            lengthMenu: [[25, 50, 100, 500, -1], [25, 50, 100, 500, "å…¨éƒ¨"]],
            orderCellsTop: true,
            fixedHeader: true,
            scrollX: true,
            language: {
                "processing": "å¤„ç†ä¸­...",
                "lengthMenu": "æ˜¾ç¤º _MENU_ é¡¹",
                "zeroRecords": "æ²¡æœ‰åŒ¹é…ç»“æœ",
                "info": "æ˜¾ç¤ºç¬¬ _START_ è‡³ _END_ é¡¹ç»“æœï¼Œå…± _TOTAL_ é¡¹",
                "infoEmpty": "æ— æ•°æ®",
                "infoFiltered": "(ç”± _MAX_ é¡¹ç»“æœè¿‡æ»¤)",
                "search": "å…¨å±€æœç´¢:",
                "paginate": { "next": "ä¸‹é¡µ", "previous": "ä¸Šé¡µ" }
            },
            initComplete: function () {
                const api = this.api();
                const $thead = $(api.table().header());
                
                if ($thead.find('tr.filter-row').length > 0) return;

                const trClone = $thead.find('tr:eq(0)').clone(true).addClass('filter-row').appendTo($thead);
                
                trClone.find('th').empty().removeClass('sorting sorting_asc sorting_desc');

                api.columns().every(function () {
                    const column = this;
                    if (!column.visible()) return;

                    const visibleIdx = column.index('visible');
                    const $th = trClone.find('th').eq(visibleIdx);

                    const select = $('<select class="filter-select"><option value="">å…¨éƒ¨</option></select>')
                        .appendTo($th)
                        .on('click', function(e) { e.stopPropagation(); })
                        .on('change', function() {
                            const val = $.fn.dataTable.util.escapeRegex($(this).val());
                            column.search(val ? '^' + val + '$' : '', true, false).draw();
                        });

                    column.data().unique().sort().each(function(d) {
                        if (d !== "") {
                            let text = d;
                            if (text.length > 20) text = text.substr(0,20) + '...';
                            select.append('<option value="' + d + '">' + text + '</option>');
                        }
                    });
                });
            }
        });
    }
</script>
</body>
</html>
